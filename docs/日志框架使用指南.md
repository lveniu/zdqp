# 日志框架使用指南

## 概述

统一日志框架是整点抢券系统的核心组件，提供完整的日志管理功能：

- ✅ **日志分级**: TRACE/DEBUG/INFO/SUCCESS/WARNING/ERROR/CRITICAL
- ✅ **日志分类**: 按业务类型分类（API/抢券/签到/积分/系统等）
- ✅ **时间命名**: 按天自动切割，格式 `level_年_月_日.log`
- ✅ **重要推送**: 关键事件自动推送通知
- ✅ **结构化日志**: 支持 JSON 格式日志，便于分析

## 日志文件结构

### 文件命名规则

日志文件按日志级别命名，格式为 `级别_年_月_日.log`：

```
logs/
├── trace_2024_01_15.log      # 跟踪日志（保留7天）
├── debug_2024_01_15.log      # 调试日志（保留15天）
├── info_2024_01_15.log       # 信息日志（保留30天）
├── success_2024_01_15.log    # 成功日志（保留90天）
├── warning_2024_01_15.log    # 警告日志（保留60天）
├── error_2024_01_15.log      # 错误日志（保留90天）
├── critical_2024_01_15.log   # 严重错误日志（保留180天）
└── json_2024_01_15.jsonl     # JSON格式日志（保留30天）
```

### 保留策略

| 日志级别 | 文件名 | 保留时间 | 说明 |
|---------|--------|---------|------|
| TRACE | `trace_年_月_日.log` | 7天 | 最详细的跟踪信息 |
| DEBUG | `debug_年_月_日.log` | 15天 | 调试信息 |
| INFO | `info_年_月_日.log` | 30天 | 一般信息 |
| SUCCESS | `success_年_月_日.log` | 90天 | 成功操作记录 |
| WARNING | `warning_年_月_日.log` | 60天 | 警告信息 |
| ERROR | `error_年_月_日.log` | 90天 | 错误信息（含堆栈） |
| CRITICAL | `critical_年_月_日.log` | 180天 | 严重错误（含完整诊断） |

## 快速开始

### 基础使用

```python
from src.core import get_logger, LogCategory, LogLevel

logger = get_logger()

# 记录信息日志 - 写入 info_2024_01_15.log
logger.info(LogCategory.API, "API请求开始", user_id="user001")

# 记录成功日志 - 写入 success_2024_01_15.log
logger.success(LogCategory.GRAB, "抢券成功！", user_id="user001")

# 记录错误日志 - 写入 error_2024_01_15.log
logger.error(LogCategory.DATABASE, "数据库连接失败", user_id="system")
```

### 业务专用方法

```python
from src.core import get_logger

logger = get_logger()

# API请求日志
logger.log_api_request("user001", "/api/grab", "POST", status=200)

# 抢券成功日志（会触发推送）
logger.log_grab_success("user001", 5.0, coupon_id="PDD12345")

# 抢券失败日志（会触发推送）
logger.log_grab_failed("user001", "库存不足", retry_available=True)

# 签到日志
logger.log_checkin("user001", 10, consecutive_days=7)

# Cookie过期日志（会触发推送）
logger.log_cookie_expired("user001", last_refresh="2024-01-01")

# 积分不足日志（会触发推送）
logger.log_points_low("user001", 50, required=100)
```

## 日志分类

### 业务分类

虽然日志文件按级别命名，但每条日志都包含分类标签，便于筛选：

| 分类 | 标签 | 说明 |
|-----|-----|------|
| API | `[api]` | API请求日志 |
| GRAB | `[grab]` | 抢券业务日志 |
| CHECKIN | `[checkin]` | 签到业务日志 |
| POINTS | `[points]` | 积分业务日志 |
| SYSTEM | `[system]` | 系统运行日志 |
| AUTH | `[auth]` | 认证授权日志 |
| DATABASE | `[database]` | 数据库操作日志 |
| SCHEDULER | `[scheduler]` | 调度器日志 |

### 平台分类

| 分类 | 标签 | 说明 |
|-----|-----|------|
| 拼多多 | `[pinduoduo]` | 拼多多平台日志 |
| 京东 | `[jd]` | 京东平台日志 |
| 淘宝 | `[taobao]` | 淘宝平台日志 |
| 美团 | `[meituan]` | 美团平台日志 |

## 日志级别

| 级别 | 写入文件 | 说明 | 使用场景 |
|-----|---------|------|---------|
| TRACE | `trace_*.log` | 最详细的调试信息 | 性能分析、详细跟踪 |
| DEBUG | `debug_*.log` | 调试信息 | 开发调试 |
| INFO | `info_*.log` | 一般信息 | 正常业务流程 |
| SUCCESS | `success_*.log` | 成功操作 | 抢券成功、签到成功 |
| WARNING | `warning_*.log` | 警告信息 | 积分不足、重试提醒 |
| ERROR | `error_*.log` | 错误信息 | 抢券失败、Cookie过期 |
| CRITICAL | `critical_*.log` | 严重错误 | 系统崩溃、致命错误 |

## 事件推送

### 重要事件列表

某些关键日志事件会自动触发推送通知：

| 事件 | 推送 | 写入文件 | 说明 |
|-----|-----|---------|------|
| `GRAB_SUCCESS` | ✅ | `success_*.log` | 抢券成功 |
| `GRAB_FAILED` | ✅ | `error_*.log` | 抢券失败 |
| `GRAB_TIMEOUT` | ✅ | `warning_*.log` | 抢券超时 |
| `CHECKIN_SUCCESS` | ❌ | `success_*.log` | 签到成功（不推送） |
| `CHECKIN_FAILED` | ✅ | `error_*.log` | 签到失败 |
| `SYSTEM_ERROR` | ✅ | `critical_*.log` | 系统错误 |
| `LOGIN_SUCCESS` | ❌ | `info_*.log` | 登录成功（不推送） |
| `LOGIN_FAILED` | ✅ | `warning_*.log` | 登录失败 |
| `COOKIE_EXPIRED` | ✅ | `error_*.log` | Cookie过期 |
| `POINTS_LOW` | ✅ | `warning_*.log` | 积分不足 |

### 推送消息格式

```
🎉 Grab Success | 用户: user001 | 抢券成功，获得 5 元优惠券 | 详情: coupon_value=5, coupon_id=PDD12345
```

## 配置

### YAML 配置

在 `config/config.yaml` 中配置日志：

```yaml
log:
  level: INFO              # 全局日志级别
  dir: logs                # 日志目录
  rotation: "100 MB"       # 文件大小限制
  retention: "30 days"     # 默认保留时间

  framework:
    # 推送配置
    push:
      enabled: true                        # 是否启用推送
      channels: ["serverchan", "telegram"] # 推送渠道
      push_levels:
        - SUCCESS    # 抢券成功时推送
        - ERROR      # 错误时推送
        - CRITICAL   # 严重错误时推送
```

## 日志文件示例

### info_2024_01_15.log

```
2024-01-15 10:30:45.123 | INFO     | [api]      | user001    | POST /api/grab 开始抢券
2024-01-15 10:30:46.456 | INFO     | [system]   | system     | 调度器启动，待处理任务: 5
2024-01-15 10:30:47.789 | INFO     | [checkin]  | user002    | 每日签到成功，获得10积分
```

### success_2024_01_15.log

```
2024-01-15 10:00:00.001 | SUCCESS  | [grab]     | user001    | 抢券成功，获得 5 元优惠券
2024-01-15 10:05:00.123 | SUCCESS  | [checkin]  | user001    | 签到成功，获得 10 积分
2024-01-15 10:10:00.456 | SUCCESS  | [auth]     | user001    | 用户登录成功
```

### error_2024_01_15.log

```
2024-01-15 10:15:30.123 | ERROR    | [grab]     | user001    | 抢券失败: 库存不足
2024-01-15 10:20:45.456 | ERROR    | [auth]     | user002    | Cookie已过期，请重新获取
2024-01-15 10:25:00.789 | ERROR    | [database] | system    | 数据库连接失败: Connection timeout

Traceback (most recent call last):
  File "/src/api/main.py", line 45, in grab_coupon
    ...
```

## 高级用法

### 结构化日志记录

```python
from src.core import get_logger, LogLevel, LogCategory

logger = get_logger()

# 使用 extra 参数添加结构化数据
logger.info(
    LogCategory.GRAB,
    "开始抢券",
    user_id="user001",
    extra={
        "coupon_id": "PDD12345",
        "coupon_value": 5.0,
        "target_time": "2024-01-15 10:00:00",
        "retry_count": 0
    }
)
```

### 自定义推送回调

```python
from src.core import get_logger

logger = get_logger()

def custom_push_callback(record):
    """自定义推送回调函数"""
    # 记录到数据库
    db.save_notification(record)

    # 发送到自定义服务
    requests.post("https://your-service.com/notify", json=record.to_dict())

# 注册回调
logger.register_push_callback(custom_push_callback)
```

### 异步场景使用

```python
import asyncio
from src.core import get_logger, LogCategory

logger = get_logger()

async def grab_task(user_id: str, coupon_id: str):
    logger.info(LogCategory.GRAB, f"开始抢券 {coupon_id}", user_id=user_id)

    await asyncio.sleep(0.1)

    logger.success(LogCategory.GRAB, f"抢券成功 {coupon_id}", user_id=user_id)

# 运行
asyncio.run(grab_task("user001", "PDD12345"))
```

## 日志查询

### 按日期查询

```bash
# 查看今天的错误日志
cat logs/error_2024_01_15.log

# 查看昨天的成功日志
cat logs/success_2024_01_14.log

# 搜索特定用户的日志
grep "user001" logs/info_2024_01_15.log

# 搜索特定分类的日志
grep "\[grab\]" logs/success_2024_01_15.log
```

### 按级别查询

```bash
# 查看所有错误日志
ls logs/error_*.log

# 查看所有成功日志
ls logs/success_*.log

# 搜索最近一周的警告
find logs/ -name "warning_*.log" -mtime -7
```

## 迁移指南

### 从旧日志系统迁移

旧代码（使用 loguru）：
```python
from loguru import logger

logger.info("用户登录", user_id="user001")
logger.success("抢券成功", coupon_id="PDD12345")
```

新代码（使用统一日志框架）：
```python
from src.core import get_logger, LogCategory

logger = get_logger()

logger.info(LogCategory.API, "用户登录", user_id="user001")
logger.success(LogCategory.GRAB, "抢券成功", user_id="user001", coupon_id="PDD12345")
```

## 最佳实践

1. **始终指定日志分类**：使用 `LogCategory` 枚举指定正确的日志类型
2. **传递 user_id**：便于追踪用户操作
3. **使用业务专用方法**：如 `log_grab_success`，它们会自动设置事件类型
4. **合理使用日志级别**：
   - DEBUG 仅用于开发调试
   - INFO 用于正常业务流程
   - ERROR 仅用于真正的错误
5. **添加结构化数据**：使用 `extra` 参数添加键值对数据
6. **定期清理日志**：系统会自动压缩旧日志，但建议定期检查磁盘空间

## 故障排除

### 日志文件未生成
- 检查 `logs/` 目录权限
- 确认日志级别设置正确
- 查看控制台是否有错误输出

### 推送不工作
- 检查通知渠道配置（ServerChan、Telegram 等）
- 确认事件是否在推送列表中
- 查看 `error_*.log` 文件排查问题

### 性能问题
- 调整日志级别（生产环境建议 INFO）
- 使用 `enqueue=True` 参数（已默认开启）异步写入
- 减少不必要的 DEBUG 日志
- 考虑调整日志保留时间
